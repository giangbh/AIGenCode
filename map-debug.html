<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Map Functionality</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .map-container {
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #debug-map {
            height: 100%;
            width: 100%;
        }
        h1 { color: #333; }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        button {
            padding: 8px 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #3367d6;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-top: 5px;
        }
        .result {
            padding: 15px;
            background-color: #e9f5e9;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .error {
            background-color: #f5e9e9;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Map Debugging Tool</h1>
        
        <div class="controls">
            <h2>Test Map Initialization</h2>
            <div class="form-group">
                <label for="lat">Latitude:</label>
                <input type="number" id="lat" step="0.000001" value="21.0285">
            </div>
            <div class="form-group">
                <label for="lng">Longitude:</label>
                <input type="number" id="lng" step="0.000001" value="105.8542">
            </div>
            <div class="form-group">
                <label for="location-name">Location Name:</label>
                <input type="text" id="location-name" value="Test Location">
            </div>
            <button id="init-map-btn">Initialize Map</button>
            <button id="get-current-location-btn">Get Current Location</button>
        </div>
        
        <div class="map-container">
            <div id="debug-map"></div>
        </div>
        
        <div class="controls">
            <h2>Test Location Parsing</h2>
            <div class="form-group">
                <label for="location-string">Location String (JSON format):</label>
                <textarea id="location-string" rows="4">{"lat": 21.0285, "lng": 105.8542, "name": "Test Location"}</textarea>
            </div>
            <button id="parse-location-btn">Parse Location</button>
            <button id="show-on-map-btn">Show on Map</button>
        </div>
        
        <div id="result" class="result">Results will appear here...</div>
    </div>
    
    <script>
        // Map variables
        let map = null;
        let marker = null;
        
        // DOM Elements
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');
        const locationNameInput = document.getElementById('location-name');
        const initMapBtn = document.getElementById('init-map-btn');
        const getCurrentLocationBtn = document.getElementById('get-current-location-btn');
        const locationStringInput = document.getElementById('location-string');
        const parseLocationBtn = document.getElementById('parse-location-btn');
        const showOnMapBtn = document.getElementById('show-on-map-btn');
        const resultDiv = document.getElementById('result');
        
        // Initialize map with given coordinates
        function initializeMap(lat, lng, name) {
            // Remove existing map if any
            if (map) {
                map.remove();
                map = null;
                marker = null;
            }
            
            // Create new map
            map = L.map('debug-map').setView([lat, lng], 15);
            
            // Add tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add marker
            marker = L.marker([lat, lng]).addTo(map);
            
            // Add popup if name is provided
            if (name) {
                marker.bindPopup(`<b>${name}</b>`).openPopup();
            }
            
            return { map, marker };
        }
        
        // Get current position
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by your browser'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        let errorMessage = 'Unable to retrieve your location';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'User denied the request for geolocation';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information is unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'The request to get user location timed out';
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage = 'An unknown error occurred';
                                break;
                        }
                        
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }
        
        // Display result
        function showResult(message, isError = false) {
            resultDiv.innerHTML = message;
            resultDiv.className = isError ? 'result error' : 'result';
        }
        
        // Event listeners
        initMapBtn.addEventListener('click', () => {
            try {
                const lat = parseFloat(latInput.value);
                const lng = parseFloat(lngInput.value);
                const name = locationNameInput.value.trim();
                
                if (isNaN(lat) || isNaN(lng)) {
                    throw new Error('Invalid coordinates');
                }
                
                const { map, marker } = initializeMap(lat, lng, name);
                showResult(`Map initialized successfully!\nCoordinates: ${lat}, ${lng}\nName: ${name || 'None'}`);
            } catch (error) {
                showResult(`Error initializing map: ${error.message}`, true);
            }
        });
        
        getCurrentLocationBtn.addEventListener('click', () => {
            showResult('Getting your current location...');
            
            getCurrentPosition()
                .then(position => {
                    const { lat, lng } = position;
                    
                    // Update inputs
                    latInput.value = lat;
                    lngInput.value = lng;
                    locationNameInput.value = 'My Current Location';
                    
                    // Initialize map
                    initializeMap(lat, lng, 'My Current Location');
                    
                    showResult(`Current location obtained!\nCoordinates: ${lat}, ${lng}`);
                })
                .catch(error => {
                    showResult(`Error getting current location: ${error.message}`, true);
                });
        });
        
        parseLocationBtn.addEventListener('click', () => {
            try {
                const locationString = locationStringInput.value.trim();
                const parsedLocation = JSON.parse(locationString);
                
                showResult(`Location parsed successfully:\n${JSON.stringify(parsedLocation, null, 2)}`);
            } catch (error) {
                showResult(`Error parsing location: ${error.message}`, true);
            }
        });
        
        showOnMapBtn.addEventListener('click', () => {
            try {
                const locationString = locationStringInput.value.trim();
                const parsedLocation = JSON.parse(locationString);
                
                if (!parsedLocation.lat || !parsedLocation.lng) {
                    throw new Error('Invalid location object. Must have lat and lng properties.');
                }
                
                initializeMap(parsedLocation.lat, parsedLocation.lng, parsedLocation.name);
                showResult(`Location displayed on map:\n${JSON.stringify(parsedLocation, null, 2)}`);
            } catch (error) {
                showResult(`Error showing location on map: ${error.message}`, true);
            }
        });
        
        // Initialize map on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap(21.0285, 105.8542, 'Test Location');
        });
    </script>
</body>
</html> 