<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CafeThu6 - Chia tiền nhóm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-green-700 flex items-center justify-center">
                <i data-lucide="coffee" class="w-8 h-8 mr-2"></i>
                CafeThu6
            </h1>
            <p class="text-gray-600">Chia sẻ chi phí nhóm dễ dàng</p>
            
            <!-- Current user display -->
            <div class="mt-3 inline-flex items-center justify-center px-3 py-1.5 bg-green-50 border border-green-200 rounded-full text-sm shadow-sm hidden">
                <i data-lucide="user" class="w-4 h-4 mr-1 text-green-500"></i>
                <span class="text-gray-700">Đang đăng nhập: <span id="current-user-display" class="font-medium text-green-600"></span></span>
                <button id="logout-button" class="ml-2 text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors duration-200" title="Đăng xuất">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <div id="message-box">
            <span id="message-text"></span>
        </div>

        <nav class="mb-8 border-b border-gray-200">
            <div class="-mb-px flex space-x-6" aria-label="Tabs">
                <button class="tab-button active px-6 py-3" data-tab="expenses">
                    <i data-lucide="receipt" class="mr-1"></i> Chi tiêu
                </button>
                <button class="tab-button px-6 py-3" data-tab="group-fund">
                    <i data-lucide="piggy-bank" class="mr-1"></i> Quỹ nhóm
                </button>
                <button class="tab-button px-6 py-3" data-tab="members">
                    <i data-lucide="users" class="mr-1"></i> Thành viên
                </button>
                
                <!-- Nút làm mới dữ liệu -->
                <button id="refresh-data-btn" class="ml-auto text-sm text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md flex items-center border border-transparent hover:border-blue-200 hover:bg-blue-50 transition-all duration-200 relative group">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i>
                    <span class="hidden sm:inline">Làm mới</span>
                    <!-- Tooltip -->
                    <div class="absolute hidden group-hover:block bottom-full right-0 mb-2 px-2 py-1 text-xs text-white bg-gray-800 rounded whitespace-nowrap">
                        Cập nhật dữ liệu từ Supabase
                    </div>
                </button>
            </div>
        </nav>

        <div>
            <div id="tab-content-expenses" class="tab-content active">
                <div class="bg-green-100 py-2 px-4 rounded-md mb-4 text-center">
                    <span class="text-green-800 font-medium">Đang xem: Chi tiêu</span>
                    <span class="text-sm text-gray-600 ml-2 hidden current-user-indicator">
                        • <i data-lucide="user" class="w-3 h-3 inline-block text-green-500"></i> <span class="current-user-name font-medium"></span>
                    </span>
                </div>
                
                <!-- Fund balance info card -->
                <div class="bg-gradient-to-r from-sky-100 to-blue-100 p-4 rounded-lg shadow-sm mb-6 flex items-center">
                    <div class="bg-blue-500 text-white p-2 rounded-full mr-3">
                        <i data-lucide="piggy-bank" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-sm text-blue-800">Số dư quỹ nhóm:</p>
                        <p class="text-3xl font-bold text-blue-600" id="expenses-group-fund-balance">0 VNĐ</p>
                    </div>
                    <button class="ml-auto bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors duration-200 flex items-center" id="quick-deposit-btn" onclick="displayQrCode('', 'Toàn', '1000000')">
                        <i data-lucide="qr-code" class="w-4 h-4 mr-1"></i>
                        Mã QR
                    </button>
                </div>
                
                <section id="expense-form-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-green-600 flex items-center">
                        <i data-lucide="file-plus" class="w-6 h-6 mr-2"></i>
                        <span id="form-title">Thêm chi tiêu mới</span>
                        <button id="cancel-edit-btn" class="hidden ml-4 text-sm text-red-500 hover:text-red-700 font-medium">
                            <i data-lucide="x" class="mr-1"></i>Hủy sửa
                        </button>
                    </h2>
                    <form id="expense-form">
                        <input type="hidden" id="edit-expense-id">
                        <div class="mb-4">
                            <label for="expense-name" class="block text-sm font-medium text-gray-700 mb-1">Tên chi tiêu:</label>
                            <input type="text" id="expense-name" name="expense-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="VD: Ăn trưa Bún Chả">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-1">Số tiền (VNĐ):</label>
                                <input type="text" id="expense-amount" name="expense-amount" required inputmode="numeric" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="VD: 350,000">
                            </div>
                             <div>
                                <label for="expense-date" class="block text-sm font-medium text-gray-700 mb-1">Ngày chi tiêu:</label>
                                <input type="date" id="expense-date" name="expense-date" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="payer" class="block text-sm font-medium text-gray-700 mb-1">Người trả:</label>
                            <select id="payer" name="payer" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-white">
                                </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Người tham gia:</label>
                            <div id="participants-list" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                </div>
                             <button type="button" id="toggle-all-participants-btn" class="mt-2 text-xs font-medium clear-all">Bỏ chọn tất cả</button>
                        </div>
                        <div class="mb-4 flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Chia đều chi phí?</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="split-equally-toggle" id="split-equally-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" checked/>
                                <label for="split-equally-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer">
                                     <span class="toggle-ball absolute left-0 block w-6 h-6 rounded-full bg-white shadow inset-y-0"></span>
                                </label>
                            </div>
                        </div>
                        <div id="manual-split-section" class="hidden mb-4 space-y-3">
                             <label class="block text-sm font-medium text-gray-700 mb-1">Nhập số tiền mỗi người trả:</label>
                             <div id="manual-split-inputs" class="space-y-2"></div>
                             <p id="manual-split-total-info" class="text-sm text-gray-600 mt-2">Tổng đã nhập: <span id="manual-split-current-total" class="font-semibold">0</span> VNĐ / <span id="manual-split-required-total" class="font-semibold">0</span> VNĐ</p>
                             <p id="manual-split-error" class="text-sm text-red-600 hidden">Tổng số tiền nhập phải bằng tổng chi tiêu.</p>
                        </div>
                        <button type="submit" id="save-expense-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            <i data-lucide="save" class="mr-1"></i><span id="save-btn-text">Lưu chi tiêu</span>
                        </button>
                    </form>
                </section>

                <section id="expense-list-section" class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-green-600 flex items-center">
                        <i data-lucide="list" class="w-6 h-6 mr-2"></i>
                        Danh sách chi tiêu
                    </h2>
                    <div id="expense-list" class="space-y-3">
                        <p id="no-expenses-message" class="text-gray-500 italic bg-gray-50 p-6 text-center rounded-lg border border-gray-200">Chưa có chi tiêu nào được thêm.</p>
                    </div>
                </section>

                <section id="results-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-green-600 flex items-center">
                        <i data-lucide="calculator" class="w-6 h-6 mr-2"></i>
                        Kết quả chia tiền
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                                <i data-lucide="users" class="w-5 h-5 mr-2 text-green-500"></i>
                                Tổng kết cá nhân
                            </h3>
                            <ul id="individual-summary" class="space-y-2">
                                <li class="text-gray-500 italic">Chưa có dữ liệu để tính toán.</li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                                <i data-lucide="arrows-right-left" class="w-5 h-5 mr-2 text-green-500"></i>
                                Giao dịch cần thực hiện
                            </h3>
                            <ul id="transactions" class="space-y-2">
                                <li class="text-gray-500 italic">Chưa có dữ liệu để tính toán.</li>
                            </ul>
                        </div>
                    </div>
                </section>
            </div>

            <div id="tab-content-group-fund" class="tab-content">
                <div class="bg-blue-100 py-2 px-4 rounded-md mb-4 text-center">
                    <span class="text-blue-800 font-medium">Đang xem: Quỹ nhóm</span>
                    <span class="text-sm text-gray-600 ml-2 hidden current-user-indicator">
                        • <i data-lucide="user" class="w-3 h-3 inline-block text-green-500"></i> <span class="current-user-name font-medium"></span>
                    </span>
                </div>
                <section id="group-fund-section" class="p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-sky-700 flex items-center">
                        <i data-lucide="piggy-bank" class="w-6 h-6 mr-2"></i>
                        Quản lý Quỹ nhóm
                    </h2>
                    
                    <!-- Balance Card -->
                    <div class="bg-gradient-to-r from-blue-500 to-sky-500 text-white p-5 rounded-lg shadow-md mb-6">
                        <p class="text-sm font-medium text-blue-100 mb-1">Số dư hiện tại:</p>
                        <p class="text-3xl font-bold" id="group-fund-balance-card">0 VNĐ</p>
                    </div>
                    
                    <!-- Fund Management Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Left Side: Nộp tiền vào quỹ -->
                        <div>
                            <h4 class="text-md font-semibold mb-2 text-gray-700 flex items-center">
                                <i data-lucide="coins" class="w-4 h-4 mr-1 text-sky-500"></i>
                                Nộp tiền vào quỹ
                            </h4>
                            <form id="deposit-form" class="space-y-3 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                                <div>
                                    <label for="deposit-member" class="block text-sm font-medium text-gray-700 mb-1">Thành viên</label>
                                    <select id="deposit-member" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        <!-- Options will be populated here -->
                                    </select>
                                </div>
                                <div>
                                    <label for="deposit-amount" class="block text-sm font-medium text-gray-700 mb-1">Số tiền</label>
                                    <div class="relative">
                                        <input type="text" id="deposit-amount" placeholder="Số tiền" class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">VNĐ</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="deposit-date" class="block text-sm font-medium text-gray-700 mb-1">Ngày</label>
                                    <input type="date" id="deposit-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label for="deposit-note" class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                                    <input type="text" id="deposit-note" placeholder="Ghi chú (không bắt buộc)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" class="bg-gradient-to-r from-sky-500 to-indigo-600 text-white px-4 py-2 rounded-md hover:opacity-90 transition-opacity flex items-center">
                                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                        Lưu khoản nộp
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Right Side: Thông tin quỹ -->
                        <div>
                            <h3 class="text-md font-semibold mb-2 text-gray-700 flex items-center">
                                <i data-lucide="info" class="w-4 h-4 mr-1 text-sky-500"></i>
                                Thông tin quỹ
                            </h3>
                            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                                <p class="mb-4">Số dư hiện tại: <strong id="group-fund-balance-info" class="text-xl text-sky-600">0 VNĐ</strong></p>
                                
                                <!-- Member Fund Balances -->
                                <h4 class="text-md font-semibold mb-2 text-gray-700 flex items-center">
                                    <i data-lucide="wallet" class="w-4 h-4 mr-1 text-sky-500"></i>
                                    Số dư thành viên
                                </h4>
                                <div class="bg-white p-3 rounded border border-gray-200 max-h-72 overflow-y-auto shadow-sm">
                                    <ul id="member-balances-list" class="divide-y divide-gray-100">
                                        <!-- Member balances will be populated here -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fund Pie Chart -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                            <i data-lucide="pie-chart" class="w-4 h-4 mr-1 text-sky-500"></i>
                            Biểu đồ Quỹ
                        </h3>
                        <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                            <canvas id="fund-pie-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Fund Transaction History (moved to bottom) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                            <i data-lucide="history" class="w-4 h-4 mr-1 text-sky-500"></i>
                            Lịch sử giao dịch quỹ
                        </h3>
                        <div id="group-fund-transactions-log" class="max-h-96 overflow-y-auto bg-white p-3 rounded border border-gray-200 text-sm">
                            <p id="no-fund-transactions-message" class="text-gray-500 italic">Chưa có giao dịch quỹ nào.</p>
                        </div>
                    </div>
                </section>
            </div>

            <div id="tab-content-members" class="tab-content">
                <div class="bg-purple-100 py-2 px-4 rounded-md mb-4 text-center">
                    <span class="text-purple-800 font-medium">Đang xem: Thành viên</span>
                    <span class="text-sm text-gray-600 ml-2 hidden current-user-indicator">
                        • <i data-lucide="user" class="w-3 h-3 inline-block text-green-500"></i> <span class="current-user-name font-medium"></span>
                    </span>
                </div>
                <section id="members-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-purple-600 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="users" class="w-6 h-6 mr-2"></i>
                            Quản lý Thành viên
                        </div>
                        <button id="add-member-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm flex items-center">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                            Thêm thành viên
                        </button>
                    </h2>
                    
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">Quản lý danh sách thành viên và thông tin tài khoản của họ. Bạn có thể thêm thành viên mới, chỉnh sửa thông tin tài khoản hoặc xóa thành viên khỏi nhóm.</p>
                        
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                            <i data-lucide="users" class="w-5 h-5 mr-2 text-purple-500"></i>
                            Danh sách thành viên
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div id="members-list" class="space-y-3">
                                <!-- Member list will be populated here -->
                                <p id="no-members-message" class="text-gray-500 italic text-center py-4">Chưa có thành viên nào. Hãy thêm thành viên để bắt đầu.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <button id="clear-all-data-btn" class="mt-6 mb-8 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50 transition duration-150 ease-in-out">
            <i data-lucide="trash-2" class="mr-1"></i>Xóa tất cả dữ liệu
        </button>


        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Made by Cursor + Claude</p>
            <p>&copy; <span id="copyright-year"></span> CafeThu6. All rights reserved.</p>
        </footer>
    </div>

    <!-- Login Modal -->
    <div id="login-modal-backdrop" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
            <h2 class="text-xl font-bold text-green-600 mb-4 flex items-center">
                <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
                Đăng nhập CafeThu6
            </h2>
            
            <p class="text-gray-600 mb-4">Vui lòng đăng nhập để sử dụng ứng dụng. Tên đăng nhập là tên thành viên của bạn trong nhóm.</p>
            
            <div id="login-error" class="bg-red-100 text-red-700 p-3 rounded mb-4 hidden"></div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Tên đăng nhập:</label>
                    <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Nhập tên thành viên">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu:</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Mật khẩu">
                    <p class="text-xs text-gray-500 mt-1">Gợi ý: Mật khẩu mặc định là "Cafe"</p>
                </div>
                
                <button id="login-button" type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out flex items-center justify-center">
                    <i data-lucide="log-in" class="w-4 h-4 mr-1"></i>
                    Đăng nhập
                </button>
            </form>
        </div>
    </div>

    <div id="qr-modal-backdrop">
        <div id="qr-modal-content">
            <img id="qr-code-image" alt="QR Code">
            <h3 class="text-lg font-semibold mb-2">Quét mã để chuyển khoản</h3>
            <p class="text-sm text-gray-600 mb-4"><span id="qr-instruction"></span></p>
            <button id="close-qr-modal-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition duration-150 ease-in-out">
                <i data-lucide="x" class="mr-1"></i>Đóng
            </button>
        </div>
    </div>

    <!-- Load modular JavaScript files as ES modules -->
    <script type="module" src="js/app.js"></script>
</body>
</html> 
